<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>registration_tools.dataset.dataset &#8212; Registration Tools 0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=2709fde1"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for registration_tools.dataset.dataset</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">skimage.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">imread</span><span class="p">,</span> <span class="n">imsave</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zarr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask</span><span class="w"> </span><span class="kn">import</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">compute</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask.diagnostics</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callback</span>

<span class="k">class</span><span class="w"> </span><span class="nc">_TqdmCallback</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tqdm_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_start_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsk</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tqdm_bar</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dsk</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_pretask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">dsk</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_posttask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">dsk</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tqdm_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dsk</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">errored</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tqdm_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="check_dataset_structure">
<a class="viewcode-back" href="../../../API_dataset.html#registration_tools.dataset.check_dataset_structure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_dataset_structure</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check and print the structure of a dataset.</span>

<span class="sd">    This function prints the shape of the dataset and checks for the presence</span>
<span class="sd">    of specific attributes (&#39;axis&#39; and &#39;scale&#39;). If these attributes are found,</span>
<span class="sd">    their values are printed. If not, a message indicating their absence is printed.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    data (object): The dataset to be checked. It is expected to have a &#39;shape&#39; attribute</span>
<span class="sd">                   and optionally &#39;attrs&#39; attribute which is a dictionary containing</span>
<span class="sd">                   &#39;axis&#39; and &#39;scale&#39; keys.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shape: &quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;axis&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Axis: &quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;axis&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Axis attribute not found.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;scale&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scale: &quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;scale&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Scale attribute not found.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attributes not found.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_dataset_structure">
<a class="viewcode-back" href="../../../API_dataset.html#registration_tools.dataset.show_dataset_structure">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">show_dataset_structure</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_files</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively prints the folder structure.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    folder_path (str): The path to the folder to display.</span>
<span class="sd">    indent (int): The indentation level for nested folders.</span>
<span class="sd">    max_files (int): The maximum number of files to display per folder.</span>

<span class="sd">    Returns:</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)):</span>
        <span class="n">item_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;|-- &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">sub_items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">item_path</span><span class="p">))</span>
            <span class="n">show_dataset_structure</span><span class="p">(</span><span class="n">item_path</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">max_files</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_items</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_files</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sub_item</span> <span class="ow">in</span> <span class="n">sub_items</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|-- &#39;</span> <span class="o">+</span> <span class="n">sub_item</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|-- ...&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_item</span> <span class="ow">in</span> <span class="n">sub_items</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|-- &#39;</span> <span class="o">+</span> <span class="n">sub_item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sub_item</span> <span class="ow">in</span> <span class="n">sub_items</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|-- &#39;</span> <span class="o">+</span> <span class="n">sub_item</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_dataset">
<a class="viewcode-back" href="../../../API_dataset.html#registration_tools.dataset.load_dataset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h5_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a dataset from a given file path.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        path (str): The file path to the dataset. Supported formats are .npy, .h5, .hdf5, and image files.</span>
<span class="sd">        axis (optional): The axis attribute of the dataset. If not provided, it will be read from the dataset attributes.</span>
<span class="sd">        scale (optional): The scale attribute of the dataset. If not provided, it will be read from the dataset attributes.</span>
<span class="sd">        h5_key (str, optional): The key to read from an h5 file. Required if the file is in .h5 or .hdf5 format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        zarr.core.Array: The loaded dataset as a zarr array.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">h5_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide a key to read an h5 file.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">h5_key</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


    <span class="c1"># Check for axis and scale in dataset attributes</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="s1">&#39;attrs&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;axis&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset is missing &#39;axis&#39; attribute. Please provide it.&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
               <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis must have the same length as the number of dimensions in the dataset.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">axis</span>
        <span class="k">elif</span> <span class="s1">&#39;axis&#39;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span> <span class="ow">and</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;axis&#39; attribute is already present in the dataset. Ignoring provided &#39;axis&#39; attribute.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;scale&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale must have the same length as the number of spatial dimensions in the dataset.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scale</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset is missing attributes. Please provide &#39;axis&#39; and &#39;scale&#39; attributes.&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dataset</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">h5_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads an image file in various formats including numpy, h5, and other formats supported by scikit-image.</span>
<span class="sd">    Args:</span>
<span class="sd">        path (str): The path to the image file.</span>
<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: The image data as a numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.hdf5&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">h5_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide a key to read an h5 file.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">h5_key</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">imread</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_regex_to_list</span><span class="p">(</span><span class="n">regex</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a regex pattern to a list of numbers.</span>

<span class="sd">    Args:</span>
<span class="sd">        regex (str): The regex pattern to convert to a list of numbers.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: A list of numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
    <span class="n">regex_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">))):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">regex</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">files_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">files_</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No files found with pattern </span><span class="si">{</span><span class="n">regex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">files_</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_expand_lists</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">new_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subdata</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">new_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_expand_lists</span><span class="p">(</span><span class="n">subdata</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_data</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{.*\}&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_regex_to_list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid data format&quot;</span><span class="p">)</span>
        
<div class="viewcode-block" id="Dataset">
<a class="viewcode-back" href="../../../API_dataset.html#registration_tools.dataset.Dataset">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to represent an image dataset of files saved in several folders.</span>

<span class="sd">    Args:</span>

<span class="sd">        data (nested list or str): The data of the dataset, which can be a list of paths with regex patterns or a numpy array.</span>
<span class="sd">        axis_data (str): A string representing the format of the folder nested structure. Each character must appear only once.</span>
<span class="sd">        axis_files (str): A string representing the format of the file dimensions. Each character must appear only once.</span>
<span class="sd">        scale (tuple, optional): A tuple representing the scale for the spatial dimensions. Must be the same length as the number of spatial dimensions. If None, the scale is set to (1, 1, ..., 1). Defaults to None.</span>
<span class="sd">        h5_key (str, optional): The key to read data from an h5 file, if applicable.</span>

<span class="sd">    Examples:</span>

<span class="sd">        Having a dataset with the folowwing structure:</span>

<span class="sd">        - main_folder</span>
<span class="sd">            - ch1</span>
<span class="sd">                - file_t1.tif</span>
<span class="sd">                - file_t2.tif</span>
<span class="sd">                - ...</span>
<span class="sd">            - ch2</span>
<span class="sd">                - file_t1.tif</span>
<span class="sd">                - file_t2.tif</span>
<span class="sd">                - ...</span>

<span class="sd">        Where each file is a 3D image saved in format &#39;ZYX&#39; with scale (2., 1., 1.).</span>
<span class="sd">        You can create a dataset object with the following code:</span>
<span class="sd">        </span>
<span class="sd">            dataset = Dataset(data=[&#39;ch1/file{0:03d}.tif&#39;,&#39;ch2/file{0:03d}.tif&#39;], axis_data=&#39;CT&#39;, axis_files=&#39;ZYX&#39;, scale=(2., 1., 1.))</span>

<span class="sd">    Attributes:</span>

<span class="sd">        shape (tuple): The shape of the dataset including both data and file dimensions.</span>
<span class="sd">        scale (tuple): The scale of the spatial dimensions.</span>
<span class="sd">        _data (np.ndarray): The data of the dataset, expanded from regex patterns or file paths.</span>
<span class="sd">        _axis (str): The combined format of data and file dimensions.</span>
<span class="sd">        _n_axis (int): The total number of dimensions.</span>
<span class="sd">        _axis_data (str): The format of the folder structure.</span>
<span class="sd">        _n_axis_data (int): The number of data dimensions.</span>
<span class="sd">        _axis_files (str): The format of the file dimensions.</span>
<span class="sd">        _n_axis_files (int): The number of file dimensions.</span>
<span class="sd">        _axis_spatial (str): The spatial dimensions in the dataset.</span>
<span class="sd">        _n_axis_spatial (int): The number of spatial dimensions.</span>
<span class="sd">        dtype (np.dtype): The data type of the images.</span>
<span class="sd">        _h5_key (str): The key to read data from an h5 file, if applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">axis_data</span><span class="p">,</span> <span class="n">axis_files</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h5_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the Dataset object with the provided data, axis information, and scale.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (nested list or str): The data of the dataset, which can be a list of paths with regex patterns or a numpy array.</span>
<span class="sd">            axis_data (str): A string representing the format of the folder nested structure. Each character must appear only once.</span>
<span class="sd">            axis_files (str): A string representing the format of the file dimensions. Each character must appear only once.</span>
<span class="sd">            scale (tuple, optional): A tuple representing the scale for the spatial dimensions. Must be the same length as the number of spatial dimensions. If None, the scale is set to (1, 1, ..., 1). Defaults to None.</span>
<span class="sd">            h5_key (str, optional): The key to read data from an h5 file, if applicable.</span>

<span class="sd">        Examples:</span>
<span class="sd">            dataset = Dataset(data=[[&#39;file_c1_1.tif&#39;, &#39;file_c1_2.tif&#39;], [&#39;file_c2_1.tif&#39;, &#39;file_c2_2.tif&#39;]], axis_data=&#39;CT&#39;, axis_files=&#39;ZYX&#39;, scale=(1, 2, 3))</span>
<span class="sd">            dataset = Dataset(data=&#39;file{0:03d}.tif&#39;, axis_data=&#39;T&#39;, axis_files=&#39;ZYX&#39;, scale=(1, 2, 3))</span>
<span class="sd">            dataset = Dataset(data=[&#39;ch1/file{0:03d}.tif&#39;,&#39;ch2/file{0:03d}.tif&#39;], axis_data=&#39;CT&#39;, axis_files=&#39;ZYX&#39;, scale=(1, 2, 3))</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_expand_lists</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis_data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_axis_data</span> <span class="o">=</span> <span class="n">axis_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_axis_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis data must have the same length as the number of dimensions in the data.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid data format for axis_data&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_h5_key</span> <span class="o">=</span> <span class="n">h5_key</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h5_key</span><span class="o">=</span><span class="n">h5_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis_files</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_axis_files</span> <span class="o">=</span> <span class="n">axis_files</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_axis_files</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis_files</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Axis files must have the same length as the number of dimensions in the files.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid data format for axis_files&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">dtype</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis_data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis_files</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There are repeated symbols. Each symbol must appear only once from &#39;XYZTC&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_axis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_axis_spatial</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">dim</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="k">if</span> <span class="n">dim</span> <span class="ow">in</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_axis_spatial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis_spatial</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_axis_spatial</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_axis_spatial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale must be the same length as the number of spatial dimensions.&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a string representation of the Dataset object, including its metadata.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: A string representation of the Dataset object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Dataset(shape=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, axis=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="si">}</span><span class="s2">, scale=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows access to the dataset using array indexing and slicing.</span>
<span class="sd">        Args:</span>
<span class="sd">            index (tuple): A tuple containing the indices for each dimension.</span>
<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: The image at the specified indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span><span class="p">,)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_axis</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many indices provided. Shape of indices should be at most </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_axis</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">data_slice</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_axis_data</span><span class="p">])</span>
        <span class="n">file_slice</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_axis_data</span><span class="p">:])</span>

        <span class="n">subdata</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">data_slice</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">subdata</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">subdata</span> <span class="o">=</span> <span class="n">subdata</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">img_total</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">subdata</span><span class="p">,</span> <span class="n">h5_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5_key</span><span class="p">)[</span><span class="n">file_slice</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">subdata</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h5_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5_key</span><span class="p">)[</span><span class="n">file_slice</span><span class="p">]</span>
            <span class="n">img_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="o">*</span><span class="n">subdata</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="o">*</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">subfile</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="n">subdata</span><span class="p">):</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">subfile</span><span class="p">,</span> <span class="n">h5_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_h5_key</span><span class="p">)[</span><span class="n">file_slice</span><span class="p">]</span>
                <span class="n">img_total</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>

        <span class="k">return</span> <span class="n">img_total</span>
    
<div class="viewcode-block" id="Dataset.to_zarr_legacy">
<a class="viewcode-back" href="../../../API_dataset.html#registration_tools.dataset.Dataset.to_zarr_legacy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_zarr_legacy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the dataset to a Zarr array using the legacy method.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        file : str or zarr.storage.Store</span>
<span class="sd">            The file path or Zarr store where the array will be saved.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments to pass to `zarr.create`.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        None</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method saves the dataset to a Zarr array without parallel processing.</span>
<span class="sd">        It iterates over the dataset and saves each image sequentially.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">store</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Saving to Zarr&quot;</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;images&quot;</span><span class="p">):</span>
            <span class="n">z</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">z</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span>
        <span class="n">z</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.to_zarr_dask">
<a class="viewcode-back" href="../../../API_dataset.html#registration_tools.dataset.Dataset.to_zarr_dask">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_zarr_dask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the dataset to a Zarr file using Dask for parallel processing.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        file : str or MutableMapping</span>
<span class="sd">            The file path or MutableMapping to save the Zarr file.</span>
<span class="sd">        **kwargs : dict</span>
<span class="sd">            Additional keyword arguments to pass to the `to_zarr` method.</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        None</span>

<span class="sd">        Notes:</span>
<span class="sd">        ------</span>
<span class="sd">        This method uses Dask to parallelize the reading and saving of images.</span>
<span class="sd">        The `_read_image` function is delayed to allow for parallel execution.</span>
<span class="sd">        A progress bar is displayed using `_TqdmCallback` to show the saving progress.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nd">@delayed</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_read_image</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">delayed_arrays</span> <span class="o">=</span> <span class="p">[</span><span class="n">da</span><span class="o">.</span><span class="n">from_delayed</span><span class="p">(</span><span class="n">_read_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">),</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)]</span>
        <span class="n">new_array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">delayed_arrays</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">_TqdmCallback</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Saving to Zarr&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;images&quot;</span><span class="p">):</span>
            <span class="n">new_array</span><span class="o">.</span><span class="n">to_zarr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1">#add attributes</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">zarr</span><span class="o">.</span><span class="n">open_array</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r+&quot;</span><span class="p">)</span>
        <span class="n">z</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;axis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span>
        <span class="n">z</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dataset.to_zarr">
<a class="viewcode-back" href="../../../API_dataset.html#registration_tools.dataset.Dataset.to_zarr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_zarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;dask&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the dataset to a Zarr file.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        file (str or store): The file path or store to save the Zarr file.</span>
<span class="sd">        flavor (str, optional): The method to use for saving. Options are &#39;legacy&#39; or &#39;dask&#39;. Default is &#39;dask&#39;.</span>
<span class="sd">        **kwargs: Additional keyword arguments to pass to the respective saving method.</span>

<span class="sd">        Raises:</span>
<span class="sd">        ValueError: If an invalid flavor is provided.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s2">&quot;legacy&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_zarr_legacy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">flavor</span> <span class="o">==</span> <span class="s2">&quot;dask&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to_zarr_dask</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid flavor. Choose between &#39;legacy&#39; and &#39;dask&#39;.&quot;</span><span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Registration Tools</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>